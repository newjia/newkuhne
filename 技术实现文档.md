# é”€å”®è®¢å•æ™ºèƒ½æŸ¥è¯¢ç³»ç»Ÿ - æŠ€æœ¯å®ç°æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

åŸºäº Microsoft Copilot Studio + MCP Server æ¶æ„çš„é”€å”®è®¢å•æ™ºèƒ½æŸ¥è¯¢ç³»ç»Ÿï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€å®ç° SQLite æ•°æ®åº“çš„æŸ¥è¯¢ã€åˆ†æå’Œæ“ä½œã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- LLM é©±åŠ¨çš„è‡ªç„¶è¯­è¨€äº¤äº’
- MCP åè®®å®ç°å·¥å…·åŠ¨æ€å‘ç°
- é«˜å¯æ‰©å±•æ€§ï¼Œæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ  Tool
- æ”¯æŒäº‘ç«¯éƒ¨ç½²ï¼ˆRenderï¼‰

---

## ç³»ç»Ÿæ¶æ„

```
ç”¨æˆ· (è‡ªç„¶è¯­è¨€)
    â†“
Copilot Studio Agent (LLM æ¨ç†)
    â†“
MCP Server (HTTP/SSE)
    â†“
SQLite æ•°æ®åº“
```

### æŠ€æœ¯æ ˆ

- **å‰ç«¯**ï¼šMicrosoft Copilot Studio
- **åç«¯**ï¼šPython 3.13 + FastAPI + MCP SDK
- **æ•°æ®åº“**ï¼šSQLite 3
- **éƒ¨ç½²**ï¼šRender (Cloud Platform)
- **åè®®**ï¼šMCP (Model Context Protocol) 2024-11-05

---

## æ ¸å¿ƒç»„ä»¶

### 1. MCP Server (`mcp_server_http.py`)

**èŒè´£**ï¼š
- å®ç° MCP åè®®çš„ HTTP/SSE ä¼ è¾“
- æä¾› 8 ä¸ªè®¢å•æŸ¥è¯¢å·¥å…·
- è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“
- æ”¯æŒ REST API å’Œ MCP åè®®åŒæ¨¡å¼

**å…³é”®ç«¯ç‚¹**ï¼š

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/` | POST | MCP åè®®å…¥å£ï¼ˆinitialize, tools/list, tools/callï¼‰ |
| `/tools/{tool_name}` | POST | REST API å·¥å…·è°ƒç”¨ |
| `/openapi.json` | GET | OpenAPI è§„èŒƒï¼ˆå·¥å…·å‘ç°ï¼‰ |
| `/health` | GET | å¥åº·æ£€æŸ¥ |

**MCP åè®®æµç¨‹**ï¼š
```
1. Copilot Studio â†’ initialize
2. Server â†’ è¿”å› capabilities: {tools: {listChanged: true}}
3. Copilot Studio â†’ notifications/initialized
4. Server â†’ è¿”å› {"jsonrpc": "2.0"}  â† å…³é”®ï¼
5. Copilot Studio â†’ tools/list
6. Server â†’ è¿”å›å·¥å…·åˆ—è¡¨
```

### 2. æ•°æ®åº“è®¾è®¡

**è¡¨ç»“æ„**ï¼š

```sql
regions (region_id, region_name, city)
customers (customer_id, customer_name, region_id, contact, phone)
products (product_id, product_name, category, unit_price)
orders (order_id, customer_id, product_id, quantity, unit_price,
        total_amount, order_date, status, shipping_address, notes)
```

**è‡ªåŠ¨åˆå§‹åŒ–**ï¼š
- æœåŠ¡å¯åŠ¨æ—¶æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨
- ä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„å¹¶æ’å…¥ç¤ºä¾‹æ•°æ®
- æ”¯æŒäº‘ç«¯éƒ¨ç½²çš„æŒä¹…åŒ–å­˜å‚¨

### 3. å·¥å…·åˆ—è¡¨

| å·¥å…·åç§° | åŠŸèƒ½ | å‚æ•° |
|---------|------|------|
| `get_order_summary` | è®¢å•æ±‡æ€»ç»Ÿè®¡ | aggregate, field, condition |
| `get_orders_by_customer` | æŒ‰å®¢æˆ·åˆ†ç»„ç»Ÿè®¡ | group_by, order, limit |
| `get_orders_by_date_range` | æ—¥æœŸèŒƒå›´æŸ¥è¯¢ | start_date, end_date, status |
| `list_orders` | è®¢å•åˆ—è¡¨ | status, customer_id, limit, offset |
| `get_order_detail` | è®¢å•è¯¦æƒ… | order_id |
| `update_order_status` | æ›´æ–°è®¢å•çŠ¶æ€ | order_id, new_status |
| `get_customers` | å®¢æˆ·åˆ—è¡¨ | region_id |
| `get_products` | äº§å“åˆ—è¡¨ | category |

---

## å…³é”®æŠ€æœ¯å®ç°

### 1. Copilot Studio å·¥å…·å‘ç°é—®é¢˜è§£å†³

**é—®é¢˜**ï¼šCopilot Studio è°ƒç”¨ `initialize` åä¸ç»§ç»­è°ƒç”¨ `tools/list`

**æ ¹æœ¬åŸå› **ï¼š`notifications/initialized` å“åº”ä¸æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
if body.get("method") == "notifications/initialized":
    return {"jsonrpc": "2.0"}  # å¿…é¡»è¿”å›ç©ºçš„ JSON-RPC å“åº”
```

å‚è€ƒï¼š[Power Platform Community è§£å†³æ–¹æ¡ˆ](https://community.powerplatform.com/forums/thread/details/?threadid=20a4ae0f-d8d6-f011-8544-7c1e521c179e)

### 2. åŒåè®®æ”¯æŒ

**MCP åè®®**ï¼ˆæ ¹è·¯å¾„ `/`ï¼‰ï¼š
```python
@app.post("/")
async def root_post(request: Request):
    body = await request.json()
    if body.get("method") == "tools/list":
        tools = await list_tools()
        return {"jsonrpc": "2.0", "id": body.get("id"),
                "result": {"tools": [tool.model_dump() for tool in tools]}}
```

**REST API**ï¼ˆOpenAPI å…¼å®¹ï¼‰ï¼š
```python
@app.post("/tools/{tool_name}")
async def call_tool_rest(tool_name: str, request: Request):
    body = await request.json()
    result = await call_tool(tool_name, body)
    return {"success": True, "result": [r.text for r in result]}
```

### 3. å·¥å…·å®šä¹‰è§„èŒƒ

```python
{
    "name": "get_order_summary",
    "title": "Get Order Summary",  # Copilot Studio æ˜¾ç¤ºåç§°
    "description": "è·å–è®¢å•æ±‡æ€»ï¼ˆæ€»æ•°/æ€»å’Œ/å¹³å‡/æœ€å¤§/æœ€å°ï¼‰",
    "inputSchema": {
        "type": "object",
        "properties": {
            "aggregate": {"type": "string", "enum": ["sum", "avg", "count", "min", "max"]},
            "field": {"type": "string"},
            "condition": {"type": "string"}
        },
        "required": ["aggregate", "field"]
    }
}
```

---

## éƒ¨ç½²é…ç½®

### Render éƒ¨ç½²

**ç¯å¢ƒå˜é‡**ï¼š
```bash
PORT=10000  # Render è‡ªåŠ¨è®¾ç½®
DB_PATH=orders.db  # æ•°æ®åº“æ–‡ä»¶è·¯å¾„
```

**å¯åŠ¨å‘½ä»¤**ï¼š
```bash
uvicorn mcp_server_http:app --host 0.0.0.0 --port $PORT
```

**æŒä¹…åŒ–å­˜å‚¨**ï¼š
- æ•°æ®åº“æ–‡ä»¶å­˜å‚¨åœ¨å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ
- é‡å¯åè‡ªåŠ¨æ£€æµ‹å¹¶ä¿ç•™æ•°æ®

### æœ¬åœ°å¼€å‘

```bash
# å®‰è£…ä¾èµ–
pip install fastapi uvicorn mcp aiosqlite

# å¯åŠ¨æœåŠ¡
python mcp_server_http.py

# è®¿é—®
http://localhost:8000/
```

---

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°å·¥å…·

**æ­¥éª¤**ï¼š

1. **åœ¨ `TOOLS_DEF` æ·»åŠ å®šä¹‰**ï¼š
```python
{
    "name": "export_orders_excel",
    "title": "Export Orders to Excel",
    "description": "å¯¼å‡ºè®¢å•åˆ° Excel æ–‡ä»¶",
    "inputSchema": {
        "type": "object",
        "properties": {
            "start_date": {"type": "string"},
            "end_date": {"type": "string"}
        },
        "required": ["start_date", "end_date"]
    }
}
```

2. **å®ç°å·¥å…·å‡½æ•°**ï¼š
```python
async def export_orders_excel(args):
    start = args.get("start_date")
    end = args.get("end_date")
    # å®ç°å¯¼å‡ºé€»è¾‘
    return [TextContent(type="text", text="å¯¼å‡ºæˆåŠŸ")]
```

3. **åœ¨ `call_tool` æ·»åŠ è·¯ç”±**ï¼š
```python
elif name == "export_orders_excel":
    return await export_orders_excel(arguments)
```

4. **éƒ¨ç½²**ï¼š
```bash
git add mcp_server_http.py
git commit -m "Add export to Excel tool"
git push
```

**æ— éœ€ä¿®æ”¹ Copilot Studio**ï¼Œå·¥å…·ä¼šè‡ªåŠ¨è¢«å‘ç°ï¼

---

## æ•…éšœæ’æŸ¥

### å·¥å…·åˆ—è¡¨ä¸ºç©º

**æ£€æŸ¥é¡¹**ï¼š
1. ç¡®è®¤ `notifications/initialized` è¿”å› `{"jsonrpc": "2.0"}`
2. æŸ¥çœ‹ Render æ—¥å¿—æ˜¯å¦æœ‰ "ğŸ“‹ Received tools/list request"
3. æµ‹è¯• MCP åè®®ï¼š
```bash
curl -X POST https://newkuhne.onrender.com/ \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc": "2.0", "id": "1", "method": "tools/list", "params": {}}'
```

### å·¥å…·è°ƒç”¨å¤±è´¥

**æ£€æŸ¥é¡¹**ï¼š
1. å‚æ•°æ ¼å¼æ˜¯å¦ç¬¦åˆ `inputSchema`
2. æŸ¥çœ‹ Render æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
3. æµ‹è¯• REST APIï¼š
```bash
curl -X POST https://newkuhne.onrender.com/tools/list_orders \
  -H "Content-Type: application/json" \
  -d '{"limit": 5}'
```

---

## æ€§èƒ½ä¼˜åŒ–

1. **æ•°æ®åº“ç´¢å¼•**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
2. **è¿æ¥æ± **ï¼šä½¿ç”¨ `aiosqlite` å¼‚æ­¥è¿æ¥
3. **ç¼“å­˜**ï¼šå¯¹é™æ€æ•°æ®ï¼ˆå®¢æˆ·ã€äº§å“ï¼‰æ·»åŠ ç¼“å­˜
4. **åˆ†é¡µ**ï¼šå¤§æ•°æ®é‡æŸ¥è¯¢ä½¿ç”¨ `limit` å’Œ `offset`

---

## å®‰å…¨è€ƒè™‘

1. **SQL æ³¨å…¥é˜²æŠ¤**ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
2. **è¾“å…¥éªŒè¯**ï¼šé€šè¿‡ `inputSchema` é™åˆ¶å‚æ•°ç±»å‹
3. **è®¿é—®æ§åˆ¶**ï¼šç”Ÿäº§ç¯å¢ƒæ·»åŠ è®¤è¯æœºåˆ¶
4. **æ—¥å¿—å®¡è®¡**ï¼šè®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨

---

## æŠ€æœ¯å‚è€ƒ

- [MCP åè®®è§„èŒƒ](https://modelcontextprotocol.io/)
- [Copilot Studio MCP é›†æˆ](https://learn.microsoft.com/en-us/microsoft-copilot-studio/agent-extend-action-mcp)
- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [Pydantic V2 è¿ç§»æŒ‡å—](https://docs.pydantic.dev/latest/migration/)
